name: ðŸ“‹ Grant Intake Processing

on:
  workflow_dispatch:
    inputs:
      grant_data:
        description: 'Grant application data (JSON)'
        required: true
        type: string
      applicant_address:
        description: 'Applicant wallet address'
        required: true
        type: string
      sector:
        description: 'Grant sector (FDA/EDA/SAM)'
        required: true
        type: choice
        options:
          - FDA
          - EDA
          - SAM
        default: FDA

jobs:
  grant-intake:
    name: ðŸ›ï¸ Process Grant Intake
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - name: ðŸ”® Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ§¬ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ðŸ“¦ Install Dependencies
        run: npm ci
      
      - name: ðŸ” Validate Grant Application
        id: validate
        run: |
          echo "Validating grant application..."
          echo "::set-output name=grant_id::grant-$(date +%Y%m%d%H%M%S)"
          echo "::set-output name=timestamp::$(date -u +%Y-%m-%dT%H:%M:%SZ)"
      
      - name: ðŸ“‹ Create Grant Entry
        run: |
          # Create grant application file
          GRANT_ID="${{ steps.validate.outputs.grant_id }}"
          TIMESTAMP="${{ steps.validate.outputs.timestamp }}"
          
          cat > "data/grants/${GRANT_ID}.json" << EOF
          {
            "grant_application": {
              "id": "${GRANT_ID}",
              "status": "intake",
              "applicant": {
                "wallet_address": "${{ github.event.inputs.applicant_address }}",
                "submitted_by": "${{ github.actor }}"
              },
              "proposal": {
                "sector": "${{ github.event.inputs.sector }}",
                "raw_data": ${{ github.event.inputs.grant_data }}
              },
              "metadata": {
                "submitted_at": "${TIMESTAMP}",
                "workflow_run": "${{ github.run_id }}",
                "steward_assigned": null,
                "ceremonial_notes": "Grant intake via GitHub workflow"
              },
              "lineage": {
                "inscribed_by": "Grant Intake Workflow",
                "witness": "GitHub Actions",
                "anchor_token": "VC001"
              }
            }
          }
          EOF
          
          echo "ðŸ“‹ Grant entry created: ${GRANT_ID}"
      
      - name: ðŸ“¨ Create GSL Intake Message
        run: |
          GRANT_ID="${{ steps.validate.outputs.grant_id }}"
          TIMESTAMP="${{ steps.validate.outputs.timestamp }}"
          
          cat > "messages/intake/${GRANT_ID}.json" << EOF
          {
            "gsl_envelope": {
              "envelope_id": "intake-${GRANT_ID}",
              "message_type": "grant_intake",
              "timestamp": "${TIMESTAMP}",
              "sender": "GitHubIntakeBot",
              "recipient": "StewardReviewBot",
              "priority": "normal",
              "payload": {
                "grant_application": {
                  "grant_id": "${GRANT_ID}",
                  "applicant_address": "${{ github.event.inputs.applicant_address }}",
                  "sector": "${{ github.event.inputs.sector }}",
                  "submitted_by": "${{ github.actor }}",
                  "workflow_source": "github_actions"
                }
              },
              "ceremonial_metadata": {
                "lineage": "VC001",
                "inscribed_by": "Grant Intake Workflow",
                "witness": "GitHub Actions GSL Protocol"
              },
              "signatures": {
                "workflow_signature": "${{ github.run_id }}",
                "actor_signature": "${{ github.actor }}",
                "validation_hash": "github-actions-$(echo '${{ github.run_id }}' | sha256sum | cut -c1-32)"
              }
            }
          }
          EOF
          
          echo "ðŸ“¨ GSL intake message created"
      
      - name: ðŸ” Validate GSL Message
        run: |
          echo "ðŸ” Validating GSL message format..."
          node .github/tools/gsl-lint.js messages/intake/
      
      - name: ðŸ“Š Update Dashboard Metrics
        run: |
          echo "ðŸ“Š Updating intake metrics..."
          # This would trigger dashboard update in real implementation
          echo "Grant intake processed: ${{ steps.validate.outputs.grant_id }}"
      
      - name: ðŸ“ Commit Grant Application
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Grant Intake Bot"
          git add data/grants/ messages/intake/
          git commit -m "ðŸ“‹ Grant intake: ${{ steps.validate.outputs.grant_id }} for ${{ github.event.inputs.sector }} sector
          
          ðŸ›ï¸ Ceremonial inscription of grant application
          ðŸ“ Applicant: ${{ github.event.inputs.applicant_address }}
          ðŸ”® Sector: ${{ github.event.inputs.sector }}
          ðŸ‘¤ Submitted by: ${{ github.actor }}
          
          Witnessed by: GitHub Actions Grant Protocol"
      
      - name: ðŸš€ Push Changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
      
      - name: ðŸ“‹ Create Review Issue
        uses: actions/github-script@v7
        with:
          script: |
            const grantId = '${{ steps.validate.outputs.grant_id }}';
            const sector = '${{ github.event.inputs.sector }}';
            const applicant = '${{ github.event.inputs.applicant_address }}';
            const actor = '${{ github.actor }}';
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ” Grant Review Required: ${grantId}`,
              body: `## ðŸ›ï¸ Grant Application Review
              
              **Grant ID**: \`${grantId}\`
              **Sector**: ${sector}
              **Applicant**: \`${applicant}\`
              **Submitted by**: @${actor}
              **Timestamp**: ${{ steps.validate.outputs.timestamp }}
              
              ### ðŸ“‹ Review Checklist
              
              - [ ] Technical merit assessment
              - [ ] Financial viability review
              - [ ] Sector alignment verification
              - [ ] Ceremonial compliance check
              - [ ] Steward approval required
              
              ### ðŸ”® Next Steps
              
              1. Steward assignment for review
              2. Technical and financial assessment
              3. Approval/rejection decision
              4. Token minting authorization (if approved)
              
              ---
              
              **ðŸ§­ Ceremonial Declaration**: This grant application has been ceremonially inscribed and awaits steward review according to sovereign protocol.
              
              **Witnessed by**: GitHub Actions Grant Protocol`,
              labels: ['grant-review', `sector-${sector.toLowerCase()}`, 'pending-steward']
            });
            
            console.log(`ðŸ“‹ Review issue created: #${issue.data.number}`);
      
      - name: âœ… Grant Intake Complete
        run: |
          echo "âœ… Grant intake processing complete"
          echo "ðŸ†” Grant ID: ${{ steps.validate.outputs.grant_id }}"
          echo "ðŸ›ï¸ Sector: ${{ github.event.inputs.sector }}"
          echo "ðŸ“ Applicant: ${{ github.event.inputs.applicant_address }}"
          echo "ðŸ§­ Witnessed by: GitHub Actions Grant Protocol"