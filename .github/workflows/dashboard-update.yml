name: ğŸ“Š Dashboard Update Pipeline

on:
  schedule:
    # Update dashboard every hour
    - cron: '0 * * * *'
  
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force dashboard update'
        required: false
        type: boolean
        default: true
  
  push:
    paths:
      - 'data/grants/**'
      - 'data/glyphs/**'
      - 'data/ledger/**'

jobs:
  update-dashboard:
    runs-on: ubuntu-latest
    name: ğŸ“Š Update Status Dashboard
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ”§ Install Dependencies
        run: npm ci
        
      - name: ğŸ“Š Collect System Metrics
        run: |
          echo "ğŸ“Š Collecting system metrics..."
          
          # Count grants by status
          if [ -d "data/grants" ]; then
            TOTAL_GRANTS=$(find data/grants -name "*.json" -type f | wc -l)
            PENDING_GRANTS=$(find data/grants -name "*.json" -exec grep -l '"status": "pending"' {} \; | wc -l)
            APPROVED_GRANTS=$(find data/grants -name "*.json" -exec grep -l '"status": "approved"' {} \; | wc -l)
            MINTED_GRANTS=$(find data/grants -name "*.json" -exec grep -l '"status": "minted"' {} \; | wc -l)
            
            echo "Grant Metrics:"
            echo "  Total: $TOTAL_GRANTS"
            echo "  Pending: $PENDING_GRANTS"
            echo "  Approved: $APPROVED_GRANTS"
            echo "  Minted: $MINTED_GRANTS"
          fi
          
          # Count glyphs
          if [ -d "data/glyphs" ]; then
            TOTAL_GLYPHS=$(find data/glyphs -name "*.json" -type f | wc -l)
            echo "Total Glyphs: $TOTAL_GLYPHS"
          fi
          
          # Count L-Token transactions
          if [ -d "data/ledger" ]; then
            TOTAL_TRANSACTIONS=$(find data/ledger -name "*.json" -type f | wc -l)
            echo "L-Token Transactions: $TOTAL_TRANSACTIONS"
          fi
          
      - name: ğŸ“Š Generate Dashboard
        run: |
          echo "ğŸ“Š Generating status dashboard..."
          node packages/scripts/update-dashboard.js
          
      - name: ğŸ” Validate Dashboard
        run: |
          echo "ğŸ” Validating dashboard output..."
          
          if [ -f "docs/status-dashboard.html" ]; then
            # Basic HTML validation
            if grep -q "<html" docs/status-dashboard.html && grep -q "</html>" docs/status-dashboard.html; then
              echo "âœ… Dashboard HTML structure is valid"
            else
              echo "âŒ Dashboard HTML structure is invalid"
              exit 1
            fi
            
            # Check for required content
            if grep -q "VC001 Sovereign Status Dashboard" docs/status-dashboard.html; then
              echo "âœ… Dashboard title present"
            else
              echo "âŒ Dashboard title missing"
              exit 1
            fi
            
            echo "âœ… Dashboard validation passed"
          else
            echo "âŒ Dashboard file not generated"
            exit 1
          fi
          
      - name: ğŸ“ˆ Generate Metrics Summary
        run: |
          echo "ğŸ“ˆ Generating metrics summary..."
          
          cat > dashboard-metrics.json << EOF
          {
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "grants": {
              "total": $(find data/grants -name "*.json" -type f 2>/dev/null | wc -l),
              "pending": $(find data/grants -name "*.json" -exec grep -l '"status": "pending"' {} \; 2>/dev/null | wc -l),
              "approved": $(find data/grants -name "*.json" -exec grep -l '"status": "approved"' {} \; 2>/dev/null | wc -l),
              "minted": $(find data/grants -name "*.json" -exec grep -l '"status": "minted"' {} \; 2>/dev/null | wc -l)
            },
            "glyphs": {
              "total": $(find data/glyphs -name "*.json" -type f 2>/dev/null | wc -l)
            },
            "transactions": {
              "total": $(find data/ledger -name "*.json" -type f 2>/dev/null | wc -l)
            }
          }
          EOF
          
      - name: ğŸ” Sign Dashboard Update
        run: |
          echo "ğŸ” Signing dashboard update message..."
          
          # Create dashboard update message
          cat > dashboard-update-message.json << EOF
          {
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "action": "dashboard_updated",
            "trigger": "${{ github.event_name }}",
            "metrics_file": "dashboard-metrics.json",
            "dashboard_file": "docs/status-dashboard.html"
          }
          EOF
          
          # Sign the message
          node packages/scripts/gsl-sign.js dashboard-update-message.json "Dashboard Update System"
          
      - name: ğŸ“Š Archive Previous Dashboard
        run: |
          echo "ğŸ“Š Archiving previous dashboard versions..."
          
          # Create archive directory
          mkdir -p docs/archive/dashboards
          
          # Archive with timestamp if dashboard exists
          if [ -f "docs/status-dashboard.html" ]; then
            TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
            cp docs/status-dashboard.html "docs/archive/dashboards/dashboard_$TIMESTAMP.html"
            echo "ğŸ“ Archived: dashboard_$TIMESTAMP.html"
          fi
          
          # Keep only last 10 archived versions
          if [ -d "docs/archive/dashboards" ]; then
            find docs/archive/dashboards -name "dashboard_*.html" -type f | sort -r | tail -n +11 | xargs rm -f
          fi
          
      - name: ğŸ“¤ Commit Dashboard Updates
        if: success()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Dashboard Update Bot"
          
          if [ -n "$(git status --porcelain)" ]; then
            git add docs/status-dashboard.html
            git add docs/archive/dashboards/
            git add dashboard-metrics.json
            git add dashboard-update-message.signed.json
            
            git commit -m "ğŸ“Š Automated dashboard update - $(date)"
            git push
          else
            echo "No dashboard changes to commit"
          fi
          
      - name: ğŸš¨ Notify on Failure
        if: failure()
        run: |
          echo "âŒ Dashboard update pipeline failed"
          echo "::error::Dashboard update encountered errors"
          
      - name: ğŸ“Š Upload Dashboard Artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: dashboard-update
          path: |
            docs/status-dashboard.html
            dashboard-metrics.json
            dashboard-update-message.signed.json
          retention-days: 30